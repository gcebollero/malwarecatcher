import requests
import os
import Config
import Util
import time


def should_stop():
    if Config.is_service_enabled(__name__):
        r = requests.get('http://localhost:5000/status').json()
        return bool(r['status'] == "off")
    else:
        return True


def run():
    logger = Util.configure_log(__name__)
    response = requests.get("https://malshare.com/api.php?api_key={}&action=getlist".format(Config.retrieve_api_key(__name__)))
    missing = []
    for entry in response.json():
        entry = entry['sha256']
        if not os.path.exists(Config.FOLDER + '/' + entry + ".zip"):
            missing.append(entry)
    pending = len(missing)
    for entry in missing:
        if should_stop():
            return None
        logger.debug('Downloading {} file...'.format(entry))
        response = requests.get("https://malshare.com/api.php?api_key={}&action=getfile&hash={}".format(Config.retrieve_api_key(__name__), entry))
        if response.status_code == 200:
            Util.write_file(entry, response)
            pending -= 1
        Util.print_info(pending)
        time.sleep(5)
    logger.info('{} end.'.format(__name__))
