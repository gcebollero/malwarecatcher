import pyzipper
import Util
import os
import time


def run():
    logger = Util.configure_log(__name__)
    total = 0
    for sample in Util.get_sample_list():
        if total % 100 == 0:
            time.sleep(5)
        try:
            with pyzipper.AESZipFile(sample) as zf:
                zf.pwd = 'infected'
        except pyzipper.zipfile.BadZipFile:
            if os.path.getsize(sample) == 15:  # 'Invalid Hash...' File
                logger.debug('{} file marked as "Invalid Hash...", deleted.'.format(sample))
                os.remove(sample)
            elif os.path.getsize(sample) == 409:  # Proxy error file.
                logger.debug('{} file marked as "Proxy error", deleted.'.format(sample))
                os.remove(sample)
            elif os.path.getsize(sample) == 0:  # General error
                logger.debug('{} file marked as Zero size, deleted.'.format(sample))
                os.remove(sample)
            else:
                file = open(sample, 'r', encoding="latin1")
                header = file.read(128)  # Read 16 bytes
                header = str(header).lower()
                if '!doctype' in header or '<html' in header or '<!--':
                    logger.debug('{} file marked as "HTML file", deleted.'.format(sample))
                    os.remove(sample)
                elif 'this program cannot be run in dos mode' in header:
                    # uncompressed exe
                    logger.debug('Compresing {} file.'.format(sample))
                    new_name = sample.split('.')[0]
                    new_name = '{}.exe'.format(new_name)
                    os.rename(sample, new_name)
                    with pyzipper.AESZipFile(sample, 'w', encryption=pyzipper.WZ_AES) as zf:
                        zf.setpassword(b'infected')
                        zf.write(sample, new_name)
                    os.remove(new_name)
            total += 1
    logger.info("Processed {} files. Stopping.".format(total))